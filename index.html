<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Crypto Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="loading" class="loading-overlay hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-900"></div>
    </div>

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">My Crypto Wallet</h1>
            <button id="generateWalletBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow transition duration-200 ease-in-out">
                Generate New Wallet
            </button>
        </div>

        <div id="walletDetails" class="space-y-4 mb-8 hidden">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                <p class="text-gray-600 font-medium">Public Address:</p>
                <div class="flex items-center mt-1">
                    <input id="walletAddress" type="text" readonly class="flex-grow font-mono bg-transparent text-sm text-gray-900 overflow-x-auto whitespace-nowrap p-1 border border-gray-300 rounded-md mr-2">
                    <button id="copyAddressBtn" class="text-gray-500 hover:text-gray-900 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 2a2 2 0 00-2 2v2H5a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2v-1h-1a1 1 0 01-1-1v-4a1 1 0 00-1-1H9a1 1 0 010-2h4V4a2 2 0 00-2-2zM5 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1V8z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                <p class="text-gray-600 font-medium">Private Key:</p>
                <div class="flex items-center mt-1">
                    <input id="privateKey" type="password" readonly class="flex-grow font-mono bg-transparent text-sm text-gray-900 overflow-x-auto whitespace-nowrap p-1 border border-gray-300 rounded-md mr-2">
                    <button id="toggleKeyBtn" class="text-gray-500 hover:text-gray-900 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM10 16a6 6 0 100-12 6 6 0 000 12zM10 2a8 8 0 100 16 8 8 0 000-16z"></path></svg>
                    </button>
                </div>
                <p class="text-xs text-red-500 mt-2">Warning: Do not share your private key with anyone!</p>
            </div>

            <div class="p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm text-green-800">
                <p class="font-medium">Balance:</p>
                <p id="balance" class="text-3xl font-semibold mt-1">0.00 ETH</p>
            </div>
            
        </div>
        
        <!-- Transaction Form -->
        <div id="transactionSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Send Ether</h2>
            <div class="space-y-4">
                <div>
                    <label for="recipientAddress" class="block text-sm font-medium text-gray-700">Recipient Address</label>
                    <input type="text" id="recipientAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Amount (ETH)</label>
                    <input type="number" id="amount" step="any" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>
                <button id="sendBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow transition duration-200 ease-in-out">
                    Send Transaction
                </button>
            </div>
            <div id="transactionStatus" class="mt-4 text-center"></div>
        </div>

        <!-- Transaction History -->
        <div id="historySection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Transaction History</h2>
            <div id="transactionList" class="space-y-4">
                <p class="text-gray-500">No transactions found. Make sure you have a funded wallet and check back later.</p>
            </div>
        </div>
        
        <div id="infoMessage" class="mt-6 text-center text-gray-600">
            <p>Click "Generate New Wallet" to get started with a new Sepolia testnet wallet.</p>
        </div>
        
    </div>

    <script>
        // --- Core Wallet and Provider Setup ---
        // Changed the provider URL to a more reliable one that doesn't enforce strict referrer policies.
        const provider = new ethers.providers.JsonRpcProvider("https://sepolia.infura.io/v3/d94844dafef24d369114ab5623a3b951"); 
        let wallet;

        // --- DOM Elements ---
        const generateWalletBtn = document.getElementById('generateWalletBtn');
        const walletDetailsDiv = document.getElementById('walletDetails');
        const walletAddressInput = document.getElementById('walletAddress');
        const privateKeyInput = document.getElementById('privateKey');
        const balanceSpan = document.getElementById('balance');
        const infoMessageDiv = document.getElementById('infoMessage');
        const historySectionDiv = document.getElementById('historySection');
        const transactionSectionDiv = document.getElementById('transactionSection');
        const transactionListDiv = document.getElementById('transactionList');
        const copyAddressBtn = document.getElementById('copyAddressBtn');
        const toggleKeyBtn = document.getElementById('toggleKeyBtn');
        const sendBtn = document.getElementById('sendBtn');
        const recipientAddressInput = document.getElementById('recipientAddress');
        const amountInput = document.getElementById('amount');
        const transactionStatusDiv = document.getElementById('transactionStatus');
        const loadingOverlay = document.getElementById('loading');
        
        // --- Functions ---
        async function generateWallet() {
            showLoading();
            try {
                // Generate a new random wallet
                wallet = ethers.Wallet.createRandom().connect(provider);

                // Update the UI with wallet details
                walletAddressInput.value = wallet.address;
                privateKeyInput.value = wallet.privateKey;
                
                // Show wallet and transaction sections
                walletDetailsDiv.classList.remove('hidden');
                transactionSectionDiv.classList.remove('hidden');
                historySectionDiv.classList.remove('hidden');
                infoMessageDiv.classList.add('hidden');
                
                // Fetch and display balance and history
                await updateBalance();
                await updateTransactionHistory();

                // Show a message to the user
                showMessage("Wallet generated successfully! Send test ETH from a faucet to this address.", "success");

            } catch (error) {
                console.error("Error generating wallet:", error);
                showMessage("Failed to generate wallet. Please try again.", "error");
            } finally {
                hideLoading();
            }
        }
        
        async function updateBalance() {
            if (!wallet) return;
            showLoading();
            try {
                const balanceWei = await provider.getBalance(wallet.address);
                const balanceEth = ethers.utils.formatEther(balanceWei);
                balanceSpan.textContent = `${parseFloat(balanceEth).toFixed(4)} ETH`;
            } catch (error) {
                console.error("Error updating balance:", error);
                showMessage("Failed to fetch balance.", "error");
            } finally {
                hideLoading();
            }
        }

        async function updateTransactionHistory() {
            if (!wallet) return;
            showLoading();
            try {
                // Using a free API to fetch transaction history. Replace 'YOUR_INFURA_API_KEY'
                // with your actual key and consider using a more robust service for production.
                const url = `https://api-sepolia.etherscan.io/api?module=account&action=txlist&address=${wallet.address}&sort=desc&apikey=7EG7P74FK2YGR6VU42VFWT6Z5EZ9QEZSRC`; // NOTE: Replace with your Etherscan API key

                const response = await fetch(url);
                const data = await response.json();

                transactionListDiv.innerHTML = '';
                if (data.status === "1" && data.result.length > 0) {
                    data.result.slice(0, 10).forEach(tx => {
                        const txElement = document.createElement('div');
                        txElement.classList.add('p-3', 'bg-gray-50', 'rounded-lg', 'border', 'border-gray-200', 'flex', 'flex-col', 'space-y-1');

                        const isSender = tx.from.toLowerCase() === wallet.address.toLowerCase();
                        const valueEth = ethers.utils.formatEther(tx.value);
                        const statusColor = tx.isError === "1" ? "text-red-500" : "text-green-500";
                        const direction = isSender ? "Sent" : "Received";
                        const directionColor = isSender ? "text-red-600" : "text-green-600";

                        txElement.innerHTML = `
                            <p class="text-sm font-medium">
                                <span class="${directionColor}">${direction}</span> ${parseFloat(valueEth).toFixed(6)} ETH
                            </p>
                            <p class="text-xs text-gray-500 truncate">
                                <span class="font-medium">To:</span> ${tx.to}
                            </p>
                            <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-xs text-blue-500 hover:underline">
                                View on Etherscan
                            </a>
                        `;
                        transactionListDiv.appendChild(txElement);
                    });
                } else {
                    transactionListDiv.innerHTML = '<p class="text-gray-500">No transactions found. Fund your wallet to see history.</p>';
                }
            } catch (error) {
                console.error("Error fetching transaction history:", error);
                transactionListDiv.innerHTML = '<p class="text-gray-500">Failed to load transaction history.</p>';
            } finally {
                hideLoading();
            }
        }
        
        async function sendTransaction() {
            if (!wallet) {
                showMessage("Please generate a wallet first.", "error");
                return;
            }
            showLoading();
            try {
                const recipient = recipientAddressInput.value.trim();
                const amount = amountInput.value.trim();
                
                if (!ethers.utils.isAddress(recipient)) {
                    showMessage("Invalid recipient address.", "error");
                    return;
                }
                
                const tx = {
                    to: recipient,
                    value: ethers.utils.parseEther(amount)
                };
                
                const transactionResponse = await wallet.sendTransaction(tx);
                showMessage(`Transaction sent! Waiting for confirmation.`, "info");
                
                await transactionResponse.wait(); // Wait for the transaction to be mined
                
                showMessage(`Transaction successful! Hash: <a href="https://sepolia.etherscan.io/tx/${transactionResponse.hash}" target="_blank" class="text-blue-500 hover:underline">${transactionResponse.hash.substring(0, 10)}...</a>`, "success");
                
                // Clear form inputs
                recipientAddressInput.value = '';
                amountInput.value = '';
                
                // Update balance and history
                await updateBalance();
                await updateTransactionHistory();
                
            } catch (error) {
                console.error("Transaction failed:", error);
                showMessage(`Transaction failed: ${error.message || "Unknown error"}`, "error");
            } finally {
                hideLoading();
            }
        }

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(message, type) {
            transactionStatusDiv.textContent = ''; // Clear previous message
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-2', 'rounded-md', 'mt-2');

            if (type === "success") {
                messageElement.classList.add('bg-green-100', 'text-green-800');
            } else if (type === "error") {
                messageElement.classList.add('bg-red-100', 'text-red-800');
            } else if (type === "info") {
                messageElement.classList.add('bg-blue-100', 'text-blue-800');
            } else {
                messageElement.classList.add('bg-gray-100', 'text-gray-800');
            }
            
            messageElement.innerHTML = message;
            transactionStatusDiv.appendChild(messageElement);
        }

        // --- Event Listeners ---
        generateWalletBtn.addEventListener('click', generateWallet);
        sendBtn.addEventListener('click', sendTransaction);
        
        copyAddressBtn.addEventListener('click', () => {
            walletAddressInput.select();
            document.execCommand('copy');
            showMessage("Address copied!", "info");
        });

        toggleKeyBtn.addEventListener('click', () => {
            if (privateKeyInput.type === 'password') {
                privateKeyInput.type = 'text';
            } else {
                privateKeyInput.type = 'password';
            }
        });

        // --- Initial Load ---
        window.onload = () => {
             hideLoading();
        };

    </script>
</body>
</html>
